//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/marcussmith/HambroPerks/hambroperks_org/libphonenumber/java/libphonenumber/src/main/java/com/google/i18n/phonenumbers/MultiFileMetadataSourceImpl.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "com/google/i18n/phonenumbers/MetadataLoader.h"
#include "com/google/i18n/phonenumbers/MetadataManager.h"
#include "com/google/i18n/phonenumbers/MultiFileMetadataSourceImpl.h"
#include "com/google/i18n/phonenumbers/PhoneNumberUtil.h"
#include "com/google/i18n/phonenumbers/nano/Phonemetadata.h"
#include "com/google/protobuf/nano/CodedInputByteBufferNano.h"
#include "java/io/IOException.h"
#include "java/io/InputStream.h"
#include "java/io/ObjectInputStream.h"
#include "java/lang/IllegalStateException.h"
#include "java/lang/Integer.h"
#include "java/lang/RuntimeException.h"
#include "java/util/Collections.h"
#include "java/util/HashMap.h"
#include "java/util/Map.h"
#include "java/util/logging/Level.h"
#include "java/util/logging/Logger.h"

@interface ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl () {
 @public
  id<JavaUtilMap> regionToMetadataMap_;
  id<JavaUtilMap> countryCodeToNonGeographicalMetadataMap_;
  NSString *filePrefix_;
  id<ComGoogleI18nPhonenumbersMetadataLoader> metadataLoader_;
}

/**
 @brief Loads the metadata protocol buffer from the given stream and closes the stream afterwards.
 Any exceptions that occur while reading or closing the stream are ignored.
 @param source the non-null stream from which metadata is to be read.
 @return the loaded metadata protocol buffer.
 */
+ (ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *)loadMetadataAndCloseInputWithJavaIoObjectInputStream:(JavaIoObjectInputStream *)source;

@end

J2OBJC_FIELD_SETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, regionToMetadataMap_, id<JavaUtilMap>)
J2OBJC_FIELD_SETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, countryCodeToNonGeographicalMetadataMap_, id<JavaUtilMap>)
J2OBJC_FIELD_SETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, filePrefix_, NSString *)
J2OBJC_FIELD_SETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, metadataLoader_, id<ComGoogleI18nPhonenumbersMetadataLoader>)

static JavaUtilLoggingLogger *ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_;
J2OBJC_STATIC_FIELD_GETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, logger_, JavaUtilLoggingLogger *)

static NSString *ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_META_DATA_FILE_PREFIX_ = @"/com/google/i18n/phonenumbers/data/PhoneNumberMetadataProto";
J2OBJC_STATIC_FIELD_GETTER(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl, META_DATA_FILE_PREFIX_, NSString *)

__attribute__((unused)) static ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_loadMetadataAndCloseInputWithJavaIoObjectInputStream_(JavaIoObjectInputStream *source);

J2OBJC_INITIALIZED_DEFN(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl)

@implementation ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl

- (instancetype)initWithNSString:(NSString *)filePrefix
withComGoogleI18nPhonenumbersMetadataLoader:(id<ComGoogleI18nPhonenumbersMetadataLoader>)metadataLoader {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithNSString_withComGoogleI18nPhonenumbersMetadataLoader_(self, filePrefix, metadataLoader);
  return self;
}

- (instancetype)initWithComGoogleI18nPhonenumbersMetadataLoader:(id<ComGoogleI18nPhonenumbersMetadataLoader>)metadataLoader {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithComGoogleI18nPhonenumbersMetadataLoader_(self, metadataLoader);
  return self;
}

- (ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadata *)getMetadataForRegionWithNSString:(NSString *)regionCode {
  @synchronized(regionToMetadataMap_) {
    if (![((id<JavaUtilMap>) nil_chk(regionToMetadataMap_)) containsKeyWithId:regionCode]) {
      [self loadMetadataFromFileWithNSString:regionCode withInt:0];
    }
  }
  return [regionToMetadataMap_ getWithId:regionCode];
}

- (ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadata *)getMetadataForNonGeographicalRegionWithInt:(jint)countryCallingCode {
  @synchronized(countryCodeToNonGeographicalMetadataMap_) {
    if (![((id<JavaUtilMap>) nil_chk(countryCodeToNonGeographicalMetadataMap_)) containsKeyWithId:JavaLangInteger_valueOfWithInt_(countryCallingCode)]) {
      [self loadMetadataFromFileWithNSString:ComGoogleI18nPhonenumbersPhoneNumberUtil_get_REGION_CODE_FOR_NON_GEO_ENTITY_() withInt:countryCallingCode];
    }
  }
  return [countryCodeToNonGeographicalMetadataMap_ getWithId:JavaLangInteger_valueOfWithInt_(countryCallingCode)];
}

- (void)loadMetadataFromFileWithNSString:(NSString *)regionCode
                                 withInt:(jint)countryCallingCode {
  jboolean isNonGeoRegion = [((NSString *) nil_chk(ComGoogleI18nPhonenumbersPhoneNumberUtil_get_REGION_CODE_FOR_NON_GEO_ENTITY_())) isEqual:regionCode];
  NSString *fileName = JreStrcat("$C$", filePrefix_, '_', (isNonGeoRegion ? NSString_valueOfInt_(countryCallingCode) : regionCode));
  JavaIoInputStream *source = [((id<ComGoogleI18nPhonenumbersMetadataLoader>) nil_chk(metadataLoader_)) loadMetadataWithNSString:fileName];
  if (source == nil) {
    [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_SEVERE_() withNSString:JreStrcat("$$", @"missing metadata: ", fileName)];
    @throw [new_JavaLangIllegalStateException_initWithNSString_(JreStrcat("$$", @"missing metadata: ", fileName)) autorelease];
  }
  @try {
    ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *metadataCollection = ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_loadMetadataAndCloseInputWithJavaIoObjectInputStream_([new_JavaIoObjectInputStream_initWithJavaIoInputStream_(source) autorelease]);
    IOSObjectArray *metadataList = ((ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *) nil_chk(metadataCollection))->metadata_;
    if (((IOSObjectArray *) nil_chk(metadataList))->size_ == 0) {
      [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_SEVERE_() withNSString:JreStrcat("$$", @"empty metadata: ", fileName)];
      @throw [new_JavaLangIllegalStateException_initWithNSString_(JreStrcat("$$", @"empty metadata: ", fileName)) autorelease];
    }
    if (metadataList->size_ > 1) {
      [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_WARNING_() withNSString:JreStrcat("$$", @"invalid metadata (too many entries): ", fileName)];
    }
    ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadata *metadata = IOSObjectArray_Get(metadataList, 0);
    if (isNonGeoRegion) {
      [((id<JavaUtilMap>) nil_chk(countryCodeToNonGeographicalMetadataMap_)) putWithId:JavaLangInteger_valueOfWithInt_(countryCallingCode) withId:metadata];
    }
    else {
      [((id<JavaUtilMap>) nil_chk(regionToMetadataMap_)) putWithId:regionCode withId:metadata];
    }
  }
  @catch (JavaIoIOException *e) {
    [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_SEVERE_() withNSString:JreStrcat("$$", @"cannot load/parse metadata: ", fileName) withJavaLangThrowable:e];
    @throw [new_JavaLangRuntimeException_initWithNSString_withJavaLangThrowable_(JreStrcat("$$", @"cannot load/parse metadata: ", fileName), e) autorelease];
  }
}

+ (ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *)loadMetadataAndCloseInputWithJavaIoObjectInputStream:(JavaIoObjectInputStream *)source {
  return ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_loadMetadataAndCloseInputWithJavaIoObjectInputStream_(source);
}

- (void)dealloc {
  RELEASE_(regionToMetadataMap_);
  RELEASE_(countryCodeToNonGeographicalMetadataMap_);
  RELEASE_(filePrefix_);
  RELEASE_(metadataLoader_);
  [super dealloc];
}

+ (void)initialize {
  if (self == [ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl class]) {
    JreStrongAssign(&ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_, nil, JavaUtilLoggingLogger_getLoggerWithNSString_([ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_class_() getName]));
    J2OBJC_SET_INITIALIZED(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl)
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithNSString:withComGoogleI18nPhonenumbersMetadataLoader:", "MultiFileMetadataSourceImpl", NULL, 0x1, NULL, NULL },
    { "initWithComGoogleI18nPhonenumbersMetadataLoader:", "MultiFileMetadataSourceImpl", NULL, 0x1, NULL, NULL },
    { "getMetadataForRegionWithNSString:", "getMetadataForRegion", "Lcom.google.i18n.phonenumbers.nano.Phonemetadata$PhoneMetadata;", 0x1, NULL, NULL },
    { "getMetadataForNonGeographicalRegionWithInt:", "getMetadataForNonGeographicalRegion", "Lcom.google.i18n.phonenumbers.nano.Phonemetadata$PhoneMetadata;", 0x1, NULL, NULL },
    { "loadMetadataFromFileWithNSString:withInt:", "loadMetadataFromFile", "V", 0x0, NULL, NULL },
    { "loadMetadataAndCloseInputWithJavaIoObjectInputStream:", "loadMetadataAndCloseInput", "Lcom.google.i18n.phonenumbers.nano.Phonemetadata$PhoneMetadataCollection;", 0xa, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "logger_", NULL, 0x1a, "Ljava.util.logging.Logger;", &ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_, NULL,  },
    { "META_DATA_FILE_PREFIX_", NULL, 0x1a, "Ljava.lang.String;", &ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_META_DATA_FILE_PREFIX_, NULL,  },
    { "regionToMetadataMap_", NULL, 0x12, "Ljava.util.Map;", NULL, "Ljava/util/Map<Ljava/lang/String;Lcom/google/i18n/phonenumbers/nano/Phonemetadata$PhoneMetadata;>;",  },
    { "countryCodeToNonGeographicalMetadataMap_", NULL, 0x12, "Ljava.util.Map;", NULL, "Ljava/util/Map<Ljava/lang/Integer;Lcom/google/i18n/phonenumbers/nano/Phonemetadata$PhoneMetadata;>;",  },
    { "filePrefix_", NULL, 0x12, "Ljava.lang.String;", NULL, NULL,  },
    { "metadataLoader_", NULL, 0x12, "Lcom.google.i18n.phonenumbers.MetadataLoader;", NULL, NULL,  },
  };
  static const J2ObjcClassInfo _ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl = { 2, "MultiFileMetadataSourceImpl", "com.google.i18n.phonenumbers", NULL, 0x10, 6, methods, 6, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl;
}

@end

void ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithNSString_withComGoogleI18nPhonenumbersMetadataLoader_(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *self, NSString *filePrefix, id<ComGoogleI18nPhonenumbersMetadataLoader> metadataLoader) {
  NSObject_init(self);
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_set_regionToMetadataMap_(self, JavaUtilCollections_synchronizedMapWithJavaUtilMap_([new_JavaUtilHashMap_init() autorelease]));
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_set_countryCodeToNonGeographicalMetadataMap_(self, JavaUtilCollections_synchronizedMapWithJavaUtilMap_([new_JavaUtilHashMap_init() autorelease]));
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_set_filePrefix_(self, filePrefix);
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_set_metadataLoader_(self, metadataLoader);
}

ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *new_ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithNSString_withComGoogleI18nPhonenumbersMetadataLoader_(NSString *filePrefix, id<ComGoogleI18nPhonenumbersMetadataLoader> metadataLoader) {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *self = [ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl alloc];
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithNSString_withComGoogleI18nPhonenumbersMetadataLoader_(self, filePrefix, metadataLoader);
  return self;
}

void ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithComGoogleI18nPhonenumbersMetadataLoader_(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *self, id<ComGoogleI18nPhonenumbersMetadataLoader> metadataLoader) {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithNSString_withComGoogleI18nPhonenumbersMetadataLoader_(self, ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_META_DATA_FILE_PREFIX_, metadataLoader);
}

ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *new_ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithComGoogleI18nPhonenumbersMetadataLoader_(id<ComGoogleI18nPhonenumbersMetadataLoader> metadataLoader) {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl *self = [ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl alloc];
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initWithComGoogleI18nPhonenumbersMetadataLoader_(self, metadataLoader);
  return self;
}

ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_loadMetadataAndCloseInputWithJavaIoObjectInputStream_(JavaIoObjectInputStream *source) {
  ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_initialize();
  jint MULTI_FILE_BUFFER_SIZE = 16 * 1024;
  ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection *metadataCollection = [new_ComGoogleI18nPhonenumbersNanoPhonemetadata_PhoneMetadataCollection_init() autorelease];
  @try {
    [metadataCollection mergeFromWithComGoogleProtobufNanoCodedInputByteBufferNano:ComGoogleI18nPhonenumbersMetadataManager_convertStreamToByteBufferWithJavaIoObjectInputStream_withInt_(source, MULTI_FILE_BUFFER_SIZE)];
  }
  @catch (JavaIoIOException *e) {
    [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_WARNING_() withNSString:@"error reading input (ignored)" withJavaLangThrowable:e];
  }
  @finally {
    @try {
      [((JavaIoObjectInputStream *) nil_chk(source)) close];
    }
    @catch (JavaIoIOException *e) {
      [((JavaUtilLoggingLogger *) nil_chk(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_WARNING_() withNSString:@"error closing input stream (ignored)" withJavaLangThrowable:e];
    }
  }
  return metadataCollection;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoogleI18nPhonenumbersMultiFileMetadataSourceImpl)
